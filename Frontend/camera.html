<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Camera Situation Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background: #121212;
            color: #f0f0f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .logo-text {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(to right, #4cc9f0, #4361ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(76, 201, 240, 0.1);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
        }
        
        .status-dot.connecting {
            background: #f59e0b;
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.error {
            background: #ef4444;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            flex: 1;
            padding: 20px;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .camera-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            background: #1e1e2e;
            aspect-ratio: 16/9;
        }
        
        .camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #0a0a0a;
            display: block;
            transform: scaleX(-1); /* Mirror the camera feed */
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .recording-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(229, 57, 53, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 5;
        }
        
        .recording-dot {
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        
        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }
        
        .control-btn {
            background: #2d2d3a;
            border: none;
            color: #f0f0f0;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .control-btn:hover {
            background: #3a3a4a;
            transform: translateY(-2px);
        }
        
        .control-btn:active {
            transform: translateY(1px);
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .capture-btn {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            width: 70px;
            height: 70px;
        }
        
        .capture-btn.analyzing {
            background: linear-gradient(135deg, #f72585, #b5179e);
            animation: pulse 1.5s infinite;
        }
        
        .analysis-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .analysis-card {
            background: #1e1e2e;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2d2d3a;
        }
        
        .card-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .situation-description {
            line-height: 1.6;
            font-size: 16px;
            color: #b8b8b8;
            min-height: 80px;
        }
        
        .object-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .object-tag {
            background: rgba(67, 97, 238, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .alert-item {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .alert-item.medium {
            background: rgba(245, 158, 11, 0.1);
            border-left-color: #f59e0b;
        }
        
        .alert-item.low {
            background: rgba(34, 197, 94, 0.1);
            border-left-color: #22c55e;
        }
        
        .alert-priority {
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .alert-message {
            font-size: 14px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            background: #1a1a2e;
            padding: 12px 20px;
            font-size: 14px;
            color: #a0a0a0;
            border-top: 1px solid #2d2d3a;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-processing {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .processing-dots {
            display: flex;
            gap: 4px;
        }
        
        .processing-dot {
            width: 8px;
            height: 8px;
            background: #4cc9f0;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .processing-dot:nth-child(1) { animation-delay: -0.32s; }
        .processing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(to right, #4cc9f0, #4361ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            font-size: 12px;
            color: #a0a0a0;
            text-transform: uppercase;
        }
        
        .detection-box {
            position: absolute;
            border: 2px solid;
            border-radius: 4px;
            font-size: 12px;
            padding: 2px 4px;
            background: rgba(0, 0, 0, 0.5);
            pointer-events: none;
            z-index: 2;
        }
        
        .detection-label {
            position: absolute;
            top: -20px;
            left: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
        }
        
        .person { border-color: #4cc9f0; color: #4cc9f0; }
        .vehicle { border-color: #f72585; color: #f72585; }
        .animal { border-color: #4ade80; color: #4ade80; }
        .furniture { border-color: #f59e0b; color: #f59e0b; }
        .electronic { border-color: #8b5cf6; color: #8b5cf6; }
        
        .settings-panel {
            background: #1e1e2e;
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .settings-panel.active {
            display: block;
        }
        
        .setting-item {
            margin-bottom: 15px;
        }
        
        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .setting-input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            background: #2d2d3a;
            border: 1px solid #3a3a4a;
            color: white;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
        }
        
        .btn-secondary {
            background: #2d2d3a;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }
            
            .camera-section {
                flex: 2;
            }
            
            .analysis-section {
                flex: 1;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1e1e2e;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.error {
            border-left: 4px solid #ef4444;
        }
        
        .toast.success {
            border-left: 4px solid #22c55e;
        }
        
        .toast.warning {
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <div class="logo-icon">AI</div>
            <div class="logo-text">Situation Monitor</div>
        </div>
        <div class="connection-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Connecting...</span>
        </div>
    </div>
    
    <div class="container">
        <div class="camera-section">
            <div class="camera-container">
                <video class="camera-feed" id="cameraFeed" autoplay muted playsinline></video>
                <div class="camera-overlay" id="cameraOverlay">
                    <!-- AI-detected objects will be placed here -->
                </div>
                <div class="recording-indicator">
                    <div class="recording-dot"></div>
                    <span>ANALYZING</span>
                </div>
            </div>
            
            <div class="camera-controls">
                <button class="control-btn" id="flipCamera">⇄</button>
                <button class="control-btn capture-btn" id="analyzeBtn">●</button>
                <button class="control-btn" id="settingsBtn">☰</button>
            </div>
            
            <div class="settings-panel" id="settingsPanel">
                <h3>AI Camera Settings</h3>
                <div class="setting-item">
                    <label class="setting-label" for="backendUrl">Backend URL</label>
                    <input type="text" class="setting-input" id="backendUrl" placeholder="https://ai-camera-backend.onrender.com">
                </div>
                <div class="setting-item">
                    <label class="setting-label" for="apiKey">API Key</label>
                    <input type="password" class="setting-input" id="apiKey" placeholder="Enter your API key">
                </div>
                <div class="setting-item">
                    <label class="setting-label" for="analysisInterval">Analysis Interval (ms)</label>
                    <input type="number" class="setting-input" id="analysisInterval" value="3000" min="1000" max="10000">
                </div>
                <div class="setting-item">
                    <label class="setting-label" for="confidenceThreshold">Confidence Threshold</label>
                    <input type="range" class="setting-input" id="confidenceThreshold" min="0.1" max="0.9" step="0.1" value="0.6">
                    <span id="confidenceValue">0.6</span>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="saveSettings">Save Settings</button>
                    <button class="btn btn-secondary" id="cancelSettings">Cancel</button>
                </div>
            </div>
        </div>
        
        <div class="analysis-section">
            <div class="analysis-card">
                <div class="card-header">
                    <div class="card-icon">📊</div>
                    <div class="card-title">Situation Analysis</div>
                </div>
                <div class="situation-description" id="situationText">
                    Initializing AI camera... Please allow camera access.
                </div>
                <div class="ai-processing">
                    <div class="processing-dots">
                        <div class="processing-dot"></div>
                        <div class="processing-dot"></div>
                        <div class="processing-dot"></div>
                    </div>
                    <span id="processingText">AI Processing Live Feed</span>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="peopleCount">0</div>
                        <div class="stat-label">People</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="objectCount">0</div>
                        <div class="stat-label">Objects</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="alertCount">0</div>
                        <div class="stat-label">Alerts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analysisId">-</div>
                        <div class="stat-label">Analysis ID</div>
                    </div>
                </div>
            </div>
            
            <div class="analysis-card">
                <div class="card-header">
                    <div class="card-icon">🔍</div>
                    <div class="card-title">Detected Objects</div>
                </div>
                <div class="object-list" id="objectList">
                    <div class="object-tag">No objects detected</div>
                </div>
            </div>
            
            <div class="analysis-card">
                <div class="card-header">
                    <div class="card-icon">⚠️</div>
                    <div class="card-title">Alerts & Notifications</div>
                </div>
                <div id="alertsContainer">
                    <div class="alert-item low">
                        <div class="alert-priority">Low Priority</div>
                        <div class="alert-message">System initialized and ready</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <span>📶</span>
            <span id="connectivityStatus">AI Connected</span>
        </div>
        <div class="status-item">
            <span>📡</span>
            <span id="analysisStatus">Ready</span>
        </div>
        <div class="status-item">
            <span>🕒</span>
            <span id="lastAnalysis">Never</span>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // AI Camera Backend Integration Class
        class AICameraBackend {
            constructor() {
                // Set default backend URL to your Render deployment
                this.apiUrl = localStorage.getItem('backendUrl') || 'https://ai-camera-backend.onrender.com';
                this.apiKey = localStorage.getItem('apiKey') || '';
                this.isAnalyzing = false;
                this.analysisInterval = parseInt(localStorage.getItem('analysisInterval')) || 3000;
                this.confidenceThreshold = parseFloat(localStorage.getItem('confidenceThreshold')) || 0.6;
            }

            async analyzeFrame(frameData) {
                if (this.isAnalyzing) {
                    console.log('Analysis in progress, skipping frame');
                    return null;
                }

                this.isAnalyzing = true;

                try {
                    console.log('Sending frame to backend:', this.apiUrl);
                    
                    const response = await fetch(`${this.apiUrl}/api/analyze-frame`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': this.apiKey ? `Bearer ${this.apiKey}` : ''
                        },
                        body: JSON.stringify({
                            frame: frameData,
                            confidence_threshold: this.confidenceThreshold,
                            max_objects: 15
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }

                    const analysis = await response.json();
                    console.log('Analysis received:', analysis);
                    return analysis;

                } catch (error) {
                    console.error('Backend analysis error:', error);
                    throw error;
                } finally {
                    this.isAnalyzing = false;
                }
            }

            async sendCameraStatus(status) {
                try {
                    await fetch(`${this.apiUrl}/api/camera-status`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': this.apiKey ? `Bearer ${this.apiKey}` : ''
                        },
                        body: JSON.stringify(status)
                    });
                } catch (error) {
                    console.error('Status update failed:', error);
                }
            }

            async testConnection() {
                try {
                    const response = await fetch(`${this.apiUrl}/api/health`, {
                        method: 'GET',
                        headers: {
                            'Authorization': this.apiKey ? `Bearer ${this.apiKey}` : ''
                        }
                    });
                    return response.ok;
                } catch (error) {
                    console.error('Connection test failed:', error);
                    return false;
                }
            }

            updateSettings(settings) {
                if (settings.backendUrl) {
                    this.apiUrl = settings.backendUrl;
                    localStorage.setItem('backendUrl', settings.backendUrl);
                }
                if (settings.apiKey !== undefined) {
                    this.apiKey = settings.apiKey;
                    localStorage.setItem('apiKey', settings.apiKey);
                }
                if (settings.analysisInterval) {
                    this.analysisInterval = settings.analysisInterval;
                    localStorage.setItem('analysisInterval', settings.analysisInterval);
                }
                if (settings.confidenceThreshold) {
                    this.confidenceThreshold = settings.confidenceThreshold;
                    localStorage.setItem('confidenceThreshold', settings.confidenceThreshold);
                }
            }
        }

        // Main Application Class
        class AICameraApp {
            constructor() {
                this.backend = new AICameraBackend();
                this.video = document.getElementById('cameraFeed');
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.stream = null;
                this.isCameraOn = false;
                this.analysisInterval = null;
                this.currentFacingMode = 'environment';
                this.isAnalyzing = false;
                
                this.initializeApp();
            }

            async initializeApp() {
                this.setupEventListeners();
                this.loadSettings();
                
                // Test backend connection first
                await this.testBackendConnection();
                await this.initializeCamera();
                this.startPeriodicAnalysis();
                
                this.showToast('AI Camera initialized successfully', 'success');
            }

            async testBackendConnection() {
                this.updateStatus('Testing backend connection...', 'connecting');
                
                const isConnected = await this.backend.testConnection();
                if (isConnected) {
                    this.updateStatus('Backend connected', 'connected');
                    this.showToast('Successfully connected to AI backend', 'success');
                } else {
                    this.updateStatus('Backend connection failed', 'error');
                    this.showToast('Backend connection failed - using simulated mode', 'warning');
                }
                
                return isConnected;
            }

            setupEventListeners() {
                // Camera controls
                document.getElementById('analyzeBtn').addEventListener('click', () => {
                    this.analyzeCurrentFrame();
                });

                document.getElementById('flipCamera').addEventListener('click', () => {
                    this.flipCamera();
                });

                document.getElementById('settingsBtn').addEventListener('click', () => {
                    this.toggleSettings();
                });

                // Settings panel
                document.getElementById('saveSettings').addEventListener('click', () => {
                    this.saveSettings();
                });

                document.getElementById('cancelSettings').addEventListener('click', () => {
                    this.toggleSettings();
                });

                document.getElementById('confidenceThreshold').addEventListener('input', (e) => {
                    document.getElementById('confidenceValue').textContent = e.target.value;
                });

                // Update status periodically
                setInterval(() => {
                    this.updateStatus();
                }, 5000);
            }

            loadSettings() {
                // Load settings from localStorage and update UI
                document.getElementById('backendUrl').value = this.backend.apiUrl;
                document.getElementById('apiKey').value = this.backend.apiKey;
                document.getElementById('analysisInterval').value = this.backend.analysisInterval;
                document.getElementById('confidenceThreshold').value = this.backend.confidenceThreshold;
                document.getElementById('confidenceValue').textContent = this.backend.confidenceThreshold;
            }

            async initializeCamera() {
                try {
                    this.updateStatus('Connecting to camera...', 'connecting');
                    
                    const constraints = {
                        video: { 
                            facingMode: this.currentFacingMode,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                    
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;
                    await this.video.play();
                    
                    this.isCameraOn = true;
                    this.updateStatus('Camera connected', 'connected');
                    
                    // Send initial status to backend
                    this.backend.sendCameraStatus({
                        status: 'active',
                        facingMode: this.currentFacingMode,
                        resolution: '1280x720',
                        timestamp: new Date().toISOString()
                    });
                    
                } catch (error) {
                    console.error('Camera initialization error:', error);
                    this.updateStatus('Camera access denied', 'error');
                    this.showToast('Camera access is required for AI analysis', 'error');
                    
                    // Fallback to simulated analysis if camera is not available
                    this.startSimulatedAnalysis();
                }
            }

            async flipCamera() {
                if (!this.stream) return;
                
                // Stop current stream
                this.stream.getTracks().forEach(track => track.stop());
                
                // Switch facing mode
                this.currentFacingMode = this.currentFacingMode === 'environment' ? 'user' : 'environment';
                
                // Reinitialize camera
                await this.initializeCamera();
            }

            async analyzeCurrentFrame() {
                if (!this.isCameraOn || this.isAnalyzing) return;
                
                this.isAnalyzing = true;
                document.getElementById('analyzeBtn').classList.add('analyzing');
                document.getElementById('processingText').textContent = 'Processing frame...';
                
                try {
                    const frameData = await this.captureFrame();
                    const analysis = await this.backend.analyzeFrame(frameData);
                    
                    if (analysis) {
                        this.updateUI(analysis);
                        this.showToast('Analysis completed', 'success');
                    }
                } catch (error) {
                    console.error('Analysis error:', error);
                    this.showToast('Analysis failed: ' + error.message, 'error');
                    // Fallback to simulated analysis
                    this.runSimulatedAnalysis();
                } finally {
                    this.isAnalyzing = false;
                    document.getElementById('analyzeBtn').classList.remove('analyzing');
                    document.getElementById('processingText').textContent = 'AI Processing Live Feed';
                }
            }

            async captureFrame() {
                if (!this.isCameraOn) {
                    // Return a blank frame if camera is not available
                    this.canvas.width = 640;
                    this.canvas.height = 480;
                    this.ctx.fillStyle = '#1a1a2e';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    return this.canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                }
                
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
                this.ctx.drawImage(this.video, 0, 0);
                return this.canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
            }

            startPeriodicAnalysis() {
                // Clear any existing interval
                if (this.analysisInterval) {
                    clearInterval(this.analysisInterval);
                }
                
                // Start new analysis interval
                this.analysisInterval = setInterval(() => {
                    if (this.isCameraOn && !this.isAnalyzing) {
                        this.analyzeCurrentFrame();
                    }
                }, this.backend.analysisInterval);
            }

            updateUI(analysis) {
                // Update situation description
                document.getElementById('situationText').textContent = analysis.situation_analysis?.description || "Analysis completed";
                
                // Update object list
                this.updateObjectList(analysis.objects_detected || []);
                
                // Update alerts
                this.updateAlerts(analysis.alerts || []);
                
                // Update stats
                document.getElementById('peopleCount').textContent = analysis.summary?.people_count || 0;
                document.getElementById('objectCount').textContent = analysis.summary?.total_objects || 0;
                document.getElementById('alertCount').textContent = analysis.alerts?.length || 0;
                document.getElementById('analysisId').textContent = analysis.analysis_id ? 
                    (analysis.analysis_id.substring(0, 8) + '...') : 'sim';
                
                // Draw bounding boxes if available
                if (analysis.objects_detected) {
                    this.drawBoundingBoxes(analysis.objects_detected);
                }
                
                // Update status bar
                document.getElementById('lastAnalysis').textContent = new Date().toLocaleTimeString();
                document.getElementById('analysisStatus').textContent = `Analyzed: ${analysis.summary?.total_objects || 0} objects`;
                
                // Update connectivity status
                this.updateStatus('Connected to AI backend', 'connected');
            }

            updateObjectList(objects) {
                const objectList = document.getElementById('objectList');
                objectList.innerHTML = '';
                
                if (objects.length === 0) {
                    objectList.innerHTML = '<div class="object-tag">No objects detected</div>';
                    return;
                }
                
                // Group objects by class
                const objectCounts = {};
                objects.forEach(obj => {
                    const objClass = obj.class;
                    objectCounts[objClass] = (objectCounts[objClass] || 0) + 1;
                });
                
                // Create object tags
                Object.entries(objectCounts).forEach(([objClass, count]) => {
                    const objectTag = document.createElement('div');
                    objectTag.className = 'object-tag';
                    
                    let icon = '🔘';
                    if (objClass === 'person') icon = '👤';
                    else if (objClass === 'car' || objClass === 'vehicle') icon = '🚗';
                    else if (objClass === 'dog' || objClass === 'cat') icon = '🐕';
                    else if (objClass.includes('chair') || objClass.includes('table')) icon = '🪑';
                    else if (objClass.includes('phone') || objClass.includes('laptop')) icon = '📱';
                    
                    objectTag.innerHTML = `${icon} ${objClass.charAt(0).toUpperCase() + objClass.slice(1)} (${count})`;
                    objectList.appendChild(objectTag);
                });
            }

            updateAlerts(alerts) {
                const alertsContainer = document.getElementById('alertsContainer');
                alertsContainer.innerHTML = '';
                
                if (alerts.length === 0) {
                    alertsContainer.innerHTML = `
                        <div class="alert-item low">
                            <div class="alert-priority">All Clear</div>
                            <div class="alert-message">No alerts detected</div>
                        </div>
                    `;
                    return;
                }
                
                alerts.forEach(alert => {
                    const alertItem = document.createElement('div');
                    alertItem.className = `alert-item ${alert.priority || 'low'}`;
                    
                    alertItem.innerHTML = `
                        <div class="alert-priority">${(alert.priority || 'low').toUpperCase()} PRIORITY</div>
                        <div class="alert-message">${alert.message || 'Unknown alert'}</div>
                    `;
                    
                    alertsContainer.appendChild(alertItem);
                });
            }

            drawBoundingBoxes(objects) {
                const overlay = document.getElementById('cameraOverlay');
                overlay.innerHTML = '';
                
                objects.forEach((obj, index) => {
                    if (!obj.bounding_box || obj.bounding_box.length < 2) return;
                    
                    // Calculate bounding box coordinates
                    const xCoords = obj.bounding_box.map(vertex => vertex.x * this.video.offsetWidth);
                    const yCoords = obj.bounding_box.map(vertex => vertex.y * this.video.offsetHeight);
                    
                    const minX = Math.min(...xCoords);
                    const maxX = Math.max(...xCoords);
                    const minY = Math.min(...yCoords);
                    const maxY = Math.max(...yCoords);
                    
                    const width = maxX - minX;
                    const height = maxY - minY;
                    
                    // Create bounding box element
                    const box = document.createElement('div');
                    box.className = `detection-box ${obj.class}`;
                    box.style.left = `${minX}px`;
                    box.style.top = `${minY}px`;
                    box.style.width = `${width}px`;
                    box.style.height = `${height}px`;
                    
                    // Create label
                    const label = document.createElement('div');
                    label.className = 'detection-label';
                    label.textContent = `${obj.class} (${(obj.confidence * 100).toFixed(1)}%)`;
                    box.appendChild(label);
                    
                    overlay.appendChild(box);
                });
            }

            updateStatus(message = '', status = '') {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                const connectivityStatus = document.getElementById('connectivityStatus');
                
                if (message) statusText.textContent = message;
                if (status) {
                    statusDot.className = 'status-dot ' + status;
                    
                    switch(status) {
                        case 'connected':
                            connectivityStatus.textContent = 'AI Connected';
                            break;
                        case 'connecting':
                            connectivityStatus.textContent = 'Connecting...';
                            break;
                        case 'error':
                            connectivityStatus.textContent = 'Connection Error';
                            break;
                    }
                }
            }

            toggleSettings() {
                const settingsPanel = document.getElementById('settingsPanel');
                settingsPanel.classList.toggle('active');
            }

            saveSettings() {
                const backendUrl = document.getElementById('backendUrl').value;
                const apiKey = document.getElementById('apiKey').value;
                const analysisInterval = document.getElementById('analysisInterval').value;
                const confidenceThreshold = document.getElementById('confidenceThreshold').value;
                
                this.backend.updateSettings({
                    backendUrl,
                    apiKey,
                    analysisInterval,
                    confidenceThreshold
                });
                
                this.startPeriodicAnalysis();
                this.toggleSettings();
                this.showToast('Settings saved successfully', 'success');
                
                // Test the new connection
                this.testBackendConnection();
            }

            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            startSimulatedAnalysis() {
                // Fallback simulated analysis when camera is not available
                this.showToast('Using simulated analysis mode', 'warning');
                setInterval(() => {
                    this.runSimulatedAnalysis();
                }, 5000);
            }

            runSimulatedAnalysis() {
                const simulatedData = {
                    situation_analysis: {
                        description: "Simulated environment analysis. Camera feed not available.",
                        environment: "indoor",
                        activity_level: "low",
                        people_count: Math.floor(Math.random() * 3),
                        object_counts: {
                            person: Math.floor(Math.random() * 3),
                            chair: Math.floor(Math.random() * 2),
                            table: 1
                        },
                        primary_objects: ["person", "chair", "table"]
                    },
                    objects_detected: [
                        {
                            class: "person",
                            confidence: 0.85 + Math.random() * 0.1,
                            bounding_box: [
                                { x: 0.3, y: 0.4 },
                                { x: 0.5, y: 0.4 },
                                { x: 0.5, y: 0.8 },
                                { x: 0.3, y: 0.8 }
                            ]
                        },
                        {
                            class: "chair",
                            confidence: 0.75 + Math.random() * 0.1,
                            bounding_box: [
                                { x: 0.6, y: 0.5 },
                                { x: 0.8, y: 0.5 },
                                { x: 0.8, y: 0.7 },
                                { x: 0.6, y: 0.7 }
                            ]
                        }
                    ],
                    alerts: [],
                    summary: {
                        total_objects: 2,
                        people_count: 1,
                        alert_level: "low"
                    },
                    analysis_id: "sim_" + Date.now()
                };
                
                this.updateUI(simulatedData);
                
                // Update status
                this.updateStatus('Using simulated mode', 'warning');
                document.getElementById('analysisStatus').textContent = 'Simulated Analysis';
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new AICameraApp();
        });
    </script>
</body>
</html>